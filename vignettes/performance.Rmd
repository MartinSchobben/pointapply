---
title: "Visualise performance"
output: rmarkdown::html_vignette
bibliography: /home/amandus/Documents/work/library/biblio.bib
biblio-style: apalike
vignette: >
  %\VignetteIndexEntry{Visualise performance}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval=FALSE
  )
```


```{r pkgs, include=FALSE, message=FALSE}
# Required packages
pkgs <- miscutils::pkg_refworker(
  c("tidyverse", "Cairo", "bibtex", "R.matlab", "cubelyr", "rlang"),
  "library.bib",
  "biblio.bib"
  )     
```


The R package `pointapply` contains the code and data to reconstruct the publication: Martin Schobben, Michiel Kienhuis, and Lubos Polerecky. 2021. *New methods to detect isotopic heterogeneity with Secondary Ion Mass Spectrometry*, preprint on [Eartharxiv](https://eartharxiv.org/).


# Introduction 

This vignette provides the details on how to plot the simulated data in order to assess the performance of the intra- and inter-isotope variability tests of the paper. The details of the ion count simulation can be found in the vignette *Sensitivity by simulation* (`vignette("simulation")`).


```{r setup, eval=TRUE}
library(point) # regression diagnostics
devtools::load_all(".") # library(pointapply) # load package
```


```{r bld, echo=FALSE, eval=TRUE}
on_build <- TRUE
```  


# Download data

The simulated data can be generated by running the code of the vignette *Sensitivity by simulation* (`vignette("simulation")`). Alternatively, processed data can be downloaded from [Zenodo](https://doi.org/10.5281/zenodo.4564170) with the function `download_point()`. 


```{r data}
# use download_point() to obtain processed data (only has to be done once)
# download_point(type = "processed")
```


# Load data

The simulated data can loaded by `load_point()`


```{r loadsimu}
# load simulated data (intra-isotope variability)
load_point("simu", "sens_IC_intra", NULL, return_name = FALSE, on_build)
# load test statistics (intra-isotope variability)
load_point("simu", "CD_eval_intra", NULL, return_name = FALSE, on_build)
load_point("simu", "CM_eval_intra", NULL, return_name = FALSE, on_build)
# distinct observations
simu_CD_eval_intra <- dplyr::distinct(simu_CD_eval_intra, M_R_Xt.sm, 
                                      .keep_all = TRUE)
# load test statistics (inter-isotope variability)
simu_inter <- load_point("simu", paste0("eval_inter_", 1:10), NULL, return_name = TRUE, on_build)
```


## Accuracy

Data transformations and accuracy measurements of model classification.


```{r transintra}
# bind the two diagnostic treatments of simulated ion (Cameca and Cooks D)
tb_eval  <- list(simu_CM_eval_intra, simu_CD_eval_intra) %>%  
  set_names(nm = c("Cameca", "Cook's D")) %>% 
  bind_rows(.id = "stat.nm") 
  
# calculate accuracy of model classification
tb_intra <-  group_by(tb_eval, stat.nm, type.nm, trend.nm, force.nm) %>% 
  summarise(
    accuracy = acc_fun(unique(force.nm), p_F, ntot = n()), 
    .groups = "drop"
    )
```


The ionization efficiency trend is converted to the


```{r}
# statistics on the single common isotope
tb_Xt <- point::stat_Xt(
  simu_sens_IC_intra, 
  trend.nm, 
  .N = N.sm, 
  .Xt = Xt.sm, 
  .stat = c("RS", "hat_RS")
  ) %>% 
  filter(species.nm == "12C")

# named vector
vc_RS <- rlang::set_names(
  tb_Xt$trend.nm,  
  nm = sprintf("%.0f", tb_Xt$RS_Xt.sm -tb_Xt$hat_RS_Xt.sm)
  )
```


```{r rename, echo=FALSE}
# rename methods, make nice labels
tb_intra <- mutate(
    tb_intra, 
    stat.nm = 
      factor(
        stat.nm, 
        levels = c("Cameca", "Cook's D"), 
        labels = c(sigma[R]~"rejection", "Cook~s~D")
        )
    )
```


## Plot the heatmap

Heatmap for model classification accuracy of intra isotope variability.


```{r intraheat}
# heatmap intra-isotope variability test
hmap1 <- heat_map(
  tb_intra,
  x = force.nm, 
  y = trend.nm,
  stat = accuracy,
  grp1 = stat.nm,
  grp2 = type.nm,
  conversion = vc_RS,
  ttl = "Intra-isotope variability",
  x_lab = expression(
    "isotope variation in substrate ("* Delta[B - A] *" \u2030 )"
    ),
  y_lab = "ionization efficiency trend (%)"
  )

# save and print
save_point(hmap1, "heat_sens_intra", width = 16, height = 14, unit = "cm", on_build = TRUE)
```


```{r echo=FALSE, eval=TRUE, fig.cap="Heatmap for model classification accuracy of the intra-isotope variability test", out.width="80%"}
 knitr::include_graphics(
   fs::path_package("pointapply", "paper/graphs", "heat_sens_intra", ext = "png")
   )
```

## Sensitivity and specificity


$$\text{Sensitivity} = \frac{TP}{TP+FN}$$

$$\text{Specificity} = \frac{TN}{TN+FP}$$


Data transformation for sensitivity and specificty along the ionization trend. 


```{r trans_sens1}
# calculate sensitivity and specificity of model classification
tb_spec<- tb_eval %>% 
  filter(trend.nm != 0) %>% 
  mutate(flag = if_else(force.nm == 0, "Specificity", "Sensitivity")) %>% 
  group_by(stat.nm, type.nm, force.nm, flag) %>% 
  summarise(
    accuracy = acc_fun(unique(force.nm), p_F, ntot = n()), 
    .groups = "drop"
    )

```


Data transformation for sensitivity and specificity along the strength of the isotope perturbation. Line plot for combined sensitivity divided over the type of isotope perturbations (symmetric or asymmetric). divided over the applied diagnostics (Cameca or Cook's D and the type of variability).


```{r line2, warning=FALSE, message=FALSE}
# line plot
hline <- heat_sum(
  tb_spec,
  x = force.nm, 
  y = accuracy,
  stat = stat.nm,
  grp1 = type.nm,
  grp2 = flag,
  ttl = "Sensitivity and specificity",
  x_lab = expression(
    "isotope variation in substrate ("* Delta[B - A] *" \u2030 )"
    ),
  y_lab = "sensitivity",
  x_sec = expression(
    "fractional size of inclusion B (" * Delta[B - A] == -20 ~ "\u2030)"
    ),
  y_sec = "specificity"
  )

# save and print
save_point(hline, "line_sens_intra", width = 10, height = 10, unit = "cm", on_build = TRUE)
```


```{r echo=FALSE, eval=TRUE, fig.cap="Sensitivity and specificity of the intra-isotope variance method", out.width="80%"}
 knitr::include_graphics(
   fs::path_package("pointapply", "paper/graphs", "line_sens_intra", ext = "png")
   )
```


# Inter-variability


```{r loadinter}
# combine datasets
eval_inter <- purrr::map_dfr(rlang::syms(simu_inter), eval)
```


Data transformation and model classification accuracy calculations for inter-variability.


```{r transinter}
# calculate accuracy of model classification
tb_inter <- group_by(eval_inter, trend.nm, execution, type.nm, anomaly.nm) %>% 
  summarise(
    accuracy = acc_fun(unique(anomaly.nm), p_inter, ntot = n()), 
    .groups = "drop"
    ) 
```


```{r interheatmap}
# heatmap inter-isotope variability test
hmap2 <- heat_map(
  tb_inter,
  x = anomaly.nm, 
  y = trend.nm,
  stat = accuracy,
  grp1 = NULL,
  grp2 = NULL,
  conversion = vc_RS,
  ttl = "Intra-isotope variability",
  x_lab = expression(
    "isotope variation in substrate ("* Delta[B - A] *" \u2030 )"
    ),
  y_lab = "ionization efficiency trend (%)",
  x_sec = expression(
    "fractional size of anomalous analyses (" * Delta[B - A] == -2 ~ "\u2030)"
    )
  )

# save and print
save_point(hmap2, "heat_sens_inter", width = 16, height = 14, unit = "cm", on_build = TRUE)
```


```{r echo=FALSE, eval=TRUE, fig.cap="Heatmap for model classification accuracy of the inter-isotope variability test", out.width="80%"}
 knitr::include_graphics(
   fs::path_package("pointapply", "paper/graphs", "heat_sens_inter", ext = "png")
   )
```
